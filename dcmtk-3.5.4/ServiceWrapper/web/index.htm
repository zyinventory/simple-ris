<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=gbk" />
    <meta http-equiv="refresh" content="10" />
	<title>PACS</title>
	<link rel="stylesheet" type="text/css" href="styles/smoothness/jquery-ui-1.9.1.custom.css" />
	<style type="text/css">
		#containerBody table	{ border-style:solid; border-width:1px; border-color:black; border-collapse:collapse; margin:0px; width:100%; }
		#containerBody thead	{ background-color:#aaa; }
		#containerBody th		{ border-style:solid; border-width:1px; }
		#containerBody td		{ border-style:solid; border-width:1px; }
		#containerBody tr:nth-child(even)	{ background-color:#ccc; }
		.highlight	{ background-color:yellow; }
	</style>
	<script type="text/javascript" src="scripts/jquery-1.8.2.min.js"></script>
	<script type="text/javascript" src="scripts/jquery-ui-1.9.1.custom.min.js"></script>
	<script type="text/javascript" src="scripts/jquery.ui.datepicker-zh-CN.js"></script>
	<script type="text/javascript" src="scripts/charhash.js"></script>
	<script type="text/javascript">
	//<![CDATA[
	    var picker, xslDoc, xslDoc2, xslDocCommon;
		var mode = getQueryString('mode');
		if (! mode) mode = 'receive';

		function viewStudy(event)
		{
			var studyUid = $('td.studyUID', event.currentTarget).attr('title');
			var studyDate = $('td.studyDate', event.currentTarget).text();
			var link = location.href;
			link = link.replace(/\/[^\/]*$/, '/indexdir/0020000d/' + toHashPath(studyUid) + '/' + studyUid + '.xml');
			if(getQueryString('debug') == '1') alertMessage(link);
			//$('applet#socketProxy')[0].setText(link);
		}
		
		function toggleHighlight(event)
		{
			$('td', event.currentTarget).toggleClass('highlight');
		}
		
		function alertMessage(targetObject)
		{
			var MaxLine = 10;
			var console = $('#console');
			var leftstr = '<div><span class="ui-icon ui-icon-alert" style="float:left; margin-right:0.5em;"></span><span>';
			var myDate = new Date();
			leftstr += ("0" + myDate.getHours()).slice(-2) + ':' + ("0" + myDate.getMinutes()).slice(-2) + ':' + ("0" + myDate.getSeconds()).slice(-2) + ' | ';
			var rightstr = '</span></div>';
			if(typeof(targetObject) == 'string' || typeof(targetObject) == 'boolean' || typeof(targetObject) == 'number')
			{
				$('#console').prepend( leftstr + targetObject + rightstr );
			}
			else
			{
				var attrs = '';
				for(var i in targetObject)
				{
					attrs += i;
					attrs += ':';
					var tagtype = typeof(targetObject[i]);
					if(tagtype == 'number' || tagtype == 'string' || tagtype == 'boolean')
						attrs += targetObject[i];
					else
						attrs += tagtype;
					attrs += '<br/>';
				}
				$('#console').prepend( leftstr + attrs + rightstr );
			}
			var consoleDivs = $('div', console);
			if(consoleDivs.size() > MaxLine) $('#console div:gt(' + --MaxLine + ')').remove();
		}

		function xslt(xml, xsl, outputDOM) {
		    if (window.ActiveXObject)    // IE
		    {
		        if (outputDOM) {
		            var outputXml = new ActiveXObject('Msxml2.DOMDocument.3.0');
		            outputXml.async = false;
		            xml.transformNodeToObject(xsl, outputXml);
		            return outputXml;
		        }
                else
		            return xml.transformNode(xsl);
		    }
		    else    // FireFox， Chrome
		    {
		        try {
		            var xsltProcessor = new XSLTProcessor();
		            xsltProcessor.importStylesheet(xsl);
		            var xmlszer = new XMLSerializer();
		            var content = xsltProcessor.transformToDocument(xml);
		            if (outputDOM)
		                return content;
                    else
		                return xmlszer.serializeToString(content);
		        } catch (ex) {
		            alertMessage(ex);
		        }
		    }
		}

		function transform(xmlDoc)
		{
		    var body = $('#containerBody');
		    body.html(xslt(xmlDoc, xslDoc));
			$('tbody tr').mouseover(toggleHighlight).mouseout(toggleHighlight); //.click(viewStudy);
		}

		function displayContent(textValue, pickerWrapper)
		{
			var result = $.get('indexdir/' + mode + '/' + textValue + '.xml', {}, transform, 'xml');
			if(result.status < 200 || result.status >= 300)
			{
				$('#containerBody').html("没有检查");
				if(getQueryString('debug') == '1') alertMessage(textValue  + ' 没有检查, ' + result.statusText);
			}
		}

		function displayPaitent(textValue) {
		    var result = $.get('indexdir/' + mode + '/' + textValue + '.xml', {}, function (xmlDoc) {
		        transform(xslt(xmlDoc, xslDoc2, true));
		    }, 'xml');
		    if (result.status < 200 || result.status >= 300) {
		        $('#containerBody').html("没有检查");
		        if (getQueryString('debug') == '1') alertMessage(textValue + ' 没有检查, ' + result.statusText);
		    }
		}

		jQuery(document).ready(function () {
		    $.ajaxSetup({ async: false });
		    var result = $.get('xslt/dayrec.xsl', {}, function (body, txt, ref) { xslDoc = body; }, 'xml');
		    if (result.status != 200) {
		        alertMessage('Load XSLT dayrec failed: ' + result.statusText);
		    }
		    result = $.get('xslt/receive.xsl', {}, function (body, txt, ref) { xslDoc2 = body; }, 'xml');
		    if (result.status != 200) {
		        alertMessage('Load XSLT receive failed: ' + result.statusText);
		    }

		    var today = $.datepicker.formatDate('yy/mm/dd', new Date());
		    picker = $('#datepicker');
		    picker.attr('readonly', true);
		    picker.val(today);
		    picker.datepicker({
		        changeMonth: true,
		        changeYear: true,
		        selectOtherMonths: true,
		        showButtonPanel: true,
		        showOtherMonths: true,
		        dateFormat: 'yy/mm/dd',
		        defaultDate: today,
		        onSelect: displayContent
		    });

		    if (mode == 'receive' || mode == '00080020') {
		        displayContent(today);
		    }
		    else {
		        var patientId = getQueryString('patientID');
		        displayPaitent(toHashPath(patientId) + '/' + patientId);
		    }

		    switch (mode) {
		        case 'receive':
		            $('div#containerHeader > label#dateDesc').text('传输日期:');
		            $('div#containerHeader > a#receive').css('display', 'none');
		            $('div#containerHeader > a#00100020').css('display', 'none');
		            break;
		        case '00080020':
		            $('div#containerHeader > label#dateDesc').text('检查日期:');
		            $('div#containerHeader > a#00080020').css('display', 'none');
		            $('div#containerHeader > a#00100020').css('display', 'none');
		            break;
		        case '00100020':
		            $('div#containerHeader > label#dateDesc').css('display', 'none');
		            $('div#containerHeader > input#datepicker').css('display', 'none');
		            $('div#containerHeader > a#00100020').attr('href', 'cgi-bin/getindex.exe?jnlp=1&patientID=' + getQueryString('patientID'));
		            break;
		        default:
		            break;
		    }
		});
	//]]>
	</script>
</head>
<body>
<div id="containerPane" class="ui-widget ui-widget-content ui-widget-helper-clearfix">
	<div id="containerHeader" class="ui-widget-header ui-widget-helper-clearfix">
		<label id="dateDesc" for="datepicker">传输日期:</label><input type="text" id="datepicker" style="width:6.5em" />
		&nbsp;&nbsp;<a id="receive" href="index.htm">传输日志</a>
		&nbsp;&nbsp;<a id="00080020" href="index.htm?mode=00080020">检查日期归档</a>
        &nbsp;&nbsp;<a id="00100020" href="#">打开所有检查</a>
        &nbsp;&nbsp;<a id="status" target="ppstatus" href="cgi-bin/getindex.exe?status=html">设备状态</a>
	</div>
	<div id="containerBody"></div>
</div>
<div id="console" class="ui-state-error"></div>
<!-- applet id="socketProxy" style="float:right" width="540" height="400" codebase="jars" archive="socketproxy.jar" code="com.walnut.applet.socketproxy.SocketProxy">
    <PARAM NAME="java_arguments" VALUE="-Djnlp.packEnabled=true"/>
</applet>
    <param name="jnlp_href" value="socketproxy.jnlp" -->
</body>
</html>
